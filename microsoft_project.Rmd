---
title: "Data Science Summer School - MSR NYC"
author: "Nikola Baci"
date: "6/21/2021"
output: 
  html_document:
    toc: true
    theme: united
---

```{r setup}
library(tidyverse)
library(lubridate)
```

## Small share of US police draw third of complaints in big cities
#### Article by [FINANCIAL TIMES](https://www.ft.com/content/141182fc-7727-4af8-a555-5418fa46d09e)

## Overview of the article
TODO: A summary of the article (I wish we could use the summary() function)

## Workflow
To ensure a smooth reading and quick understanding of the notebook, please take a
moment to get familiar with the structure of the notebook.

In the first section we read all the files for each of the cities.
Then for each city we do the following:
1. Data exploration and data wrangling - in order to graph the deciles of each city, we need to 
modify the data and construct new tables to aid in achieving our goals.
2. Plot the decies for each city

## Data

Data for NYC can be found [here](https://github.com/new-york-civil-liberties-union/NYPD-Misconduct-Complaint-Database-Updated).

Data for Chicago can be found [here](https://github.com/invinst/chicago-police-data/blob/master/data/unified_data/complaints/complaints-accused.csv.gz), [here](https://github.com/invinst/chicago-police-data/blob/master/data/unified_data/complaints/complaints-complaints.csv.gz) and [here](https://github.com/invinst/chicago-police-data/blob/master/data/unified_data/complaints/officer-filed-complaints__2017-09.csv.gz).

Data for Philadephia can be found [here]() and [here]().

```{r Data}
nyc_data <- read.csv("data/nyc_misconduct_complaint_dataset.csv")

chicago_complaints_accused <- read.csv("data/chicago_complaints_accused.csv")

chicago_complaints_complaints <- read.csv("data/chicago_complaints_complaints.csv")

chicago_complaints_by_officers <- read.csv("data/chicago_officer_filed_complaints.csv")

```

## NYC 

In the next chuck of code we create the necessary table to help us in creating the 
graph for NYC data.

### Data Wrangling
```{r NYC-Data-Wrangling, warning=FALSE}

# Goal: Bucket each officer in one of the 10 buckets by the number of complaints.
# Note: Some complaints include several allegations for the same officer
# or for a number of officers
# Note: The names are not unique or sufficient to be used to identify each officer.

nyc_by_num_complaints <- nyc_data %>%
  mutate(ReceivedDate = mdy(ReceivedDate)) %>% #convert from char to Date type
  filter(ReceivedDate >= "2007-01-01", ReceivedDate <= "2017-12-31") %>%  # get only the period between 2007-2017
  group_by(OfficerID, ComplaintID) %>%
  summarize() %>%                                       # count one officer per complaint 
  summarize(num_of_complaints = n()) %>%                # count the total complaints per officer
  arrange(num_of_complaints)                            # order in ascending order

total_complaints <- sum(nyc_by_num_complaints$num_of_complaints)  # sum of all complaints, used to obtain the percents for each bin

nyc_by_num_complaints <- nyc_by_num_complaints %>%
  mutate(bin_number = 1:nrow(nyc_by_num_complaints)) %>%  # create a new column to place the bin number 1 to 10
  mutate(bin_number = ntile(bin_number, 10)) # use the ntile function to put rows in the right bins

# collapse the table to only 10 rows that represent the bins
# for each bin find the percentage of the complaints that the bin has
# compared to the total
nyc_by_num_complaints <- nyc_by_num_complaints %>%
  group_by(bin_number) %>%
  summarize(total_complaints = (sum(num_of_complaints) / total_complaints) * 100)
```
### Graphing
Graph the deciles for NYC police complaint

```{r NYC-Graph}

nyc_by_num_complaints <-  nyc_by_num_complaints %>%
  mutate(color = c(rep(0, 9), 1)) # to help with the bar colors

# graph the deciles (bins) and their percentages
nyc_by_num_complaints %>%
  ggplot()+
  geom_histogram(aes(x = bin_number, y = total_complaints, fill = color), stat="identity", show.legend = F)+
  scale_x_continuous(breaks = seq(1, 10, 1)) + #set x-axis to go up by 1
  xlab("Decile")+
  ylab("Percent of total complaints") +
  theme(panel.background = element_rect(fill = "white", colour = "white",
                                size = 2, linetype = "solid"), # set background to white
          panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',
                                colour = "gray")) # only horizontal marks
  
```

## Chicago 

### Data Wrangling
Now we proceed to working with the Chicago data and obtaining the tables to
draw the bars.

```{r Chicago-Data-Wrangling}

chicago_accused_selected <-  chicago_complaints_accused %>%
  select(UID, cr_id, link_UID) #select only 3 out of the 10 columns

chicago_complaints_selected <- chicago_complaints_complaints %>%
  select(cr_id, complaint_date, closed_date) %>% #select only 3 out of the 11 columns
  mutate(complaint_date = ymd(complaint_date), closed_date = ymd(closed_date)) #turn char dates to Date-types

chicago_officers_selected <- chicago_complaints_by_officers %>%
  mutate(cr_id = as.character(cr_id)) #add a flag column, will help in keeping only the citizens complaints

#create a table that has three essential columns: officer id, complaint id, and data of complaint
chicago_complaints <- inner_join(chicago_accused_selected, chicago_complaints_selected, by="cr_id") %>%
  filter(complaint_date >= "2007-01-01",  closed_date <= "2017-12-31") #choose only period 2007-2017

#remove complaints that are done by officers or that are not closed yet
chicago_complaints_citizens <- anti_join(chicago_complaints, chicago_officers_selected, by="cr_id") %>%
   filter(!is.na(closed_date))

```

### Graphing
Now we can graph the decile bars. 
Note: the data includes the only the citizen complaints that were registered on or after
01/01/2007 and were closed before 01/01/2018.

```{r Explore Chicago-Graph}
#Note: the code is the same as in NYC-Graph above, the only thing that changes is the
#data table in the next line and the variables to indicate that this data is for Chicago.
chicago_by_num_complaints <- chicago_complaints_citizens %>%
  group_by(UID, cr_id) %>%
  summarize() %>%
  summarize(num_of_complaints = n()) %>% 
  arrange(num_of_complaints)


total_complaints <- sum(chicago_by_num_complaints$num_of_complaints)  

chicago_by_num_complaints <- chicago_by_num_complaints %>%
  mutate(bin_number = 1:nrow(chicago_by_num_complaints)) %>%  
  mutate(bin_number = ntile(bin_number, 10))

chicago_by_num_complaints <- chicago_by_num_complaints %>%
  group_by(bin_number) %>%
  summarize(total_complaints = (sum(num_of_complaints) / total_complaints) * 100)

chicago_by_num_complaints <-  chicago_by_num_complaints %>%
  mutate(color = c(rep(0, 9), 1))

chicago_by_num_complaints %>%
  ggplot()+
  geom_histogram(aes(x = bin_number, y = total_complaints, fill = color), stat="identity", show.legend = F)+
  scale_x_continuous(breaks = seq(1, 10, 1))+
  xlab("Decile")+
  ylab("Percent of total complaints") +
  theme(panel.background = element_rect(fill = "white", colour = "white",
                                size = 2, linetype = "solid"),
          panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                colour = "gray"),
          panel.grid.major.x = element_blank())
```


## NYC Complaints by officer gender

```{r NYC-Complaints-Gender}
head(nyc_data)

nyc_complaint_by_gender <- nyc_data %>%
  mutate(ReceivedDate = mdy(ReceivedDate)) %>% #convert from char to Date type
  filter(ReceivedDate >= "2007-01-01", ReceivedDate <= "2017-12-31") %>%  # get only the period between 2007-2017
  group_by(OfficerID, ComplaintID, OfficerGender) %>%
  summarize() %>% 
  ungroup() %>%
  group_by(OfficerID) %>%
  summarize(num_of_complaints = n(), OfficerGender) %>%
  ungroup()
  
#complaints by gender among all complaints
total_complaints <- sum(nyc_complaint_by_gender$num_of_complaints)
nyc_complaint_by_gender %>%
  group_by(OfficerGender) %>%
  summarize(percent = sum(num_of_complaints) / total_complaints) %>% 
  ggplot() +
  geom_bar(aes(x = OfficerGender, y = percent), stat = "identity") +
  scale_y_continuous(breaks = seq(0, 1, 0.1))

#complaints by gender only bin 10
nyc_complaint_by_gender <- nyc_complaint_by_gender %>%
  mutate(bin_number = 1:nrow(nyc_complaint_by_gender)) %>% # create a new column to place the bin number 1 to 10
  mutate(bin_number = ntile(bin_number, 10)) %>%
  filter(bin_number == 10)

bin_10_total_complaints <- sum(nyc_complaint_by_gender$num_of_complaints)

nyc_complaint_by_gender %>%
  group_by(OfficerGender) %>%
  summarize(percent = sum(num_of_complaints) / bin_10_total_complaints) %>% 
  ggplot() +
  geom_bar(aes(x = OfficerGender, y = percent), stat = "identity") +
  scale_y_continuous(breaks = seq(0, 1, 0.1))
```

## Complaints by officer race

In this section we will analyze the race of the officers and what proportion of
the complaints each race receives. 
Note: Please keep in mind that the we need more data to reach a conclusion. Things 
to keep in mind is the distribution of race in the police force as well as population
of these cities. 
Hypothetical example, if NYC population is composed of 80% white and 
the police force has the same proportion of white officers, then it is more likely that
the blow bars will show an overwhelming amount of complaints towards white officers.

```{r NYC-Complaints-By-Officer-Race}
nyc_complaints_by_officer_race <- nyc_data %>%
  mutate(ReceivedDate = mdy(ReceivedDate)) %>% 
  filter(ReceivedDate >= "2007-01-01", ReceivedDate <= "2017-12-31") %>%  
  group_by(OfficerID, ComplaintID, OfficerRace) %>%
  summarize() %>%
  ungroup()

nyc_complaints_by_officer_race <- nyc_complaints_by_officer_race %>%
  group_by(OfficerRace) %>%
  summarize(count = n()) %>%
  mutate(percent = count / nrow(nyc_complaints_by_officer_race) * 100)

nyc_complaints_by_officer_race %>%
  ggplot() +
  geom_bar(aes(x= OfficerRace, y = percent), stat = "identity", fill = "brown") +
  labs(title = "New York 2007-2017 complaints by officer race") +
  xlab("Officer Race") +
  ylab("Percent") +
  theme(panel.background = element_rect(fill = "white", colour = "white",
                                size = 2, linetype = "solid"),
          panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                colour = "gray"),
          panel.grid.major.x = element_blank())
```

```{r Chicago-Complaints-By-Officer-Race}
chicago_officer_profiles <- read.csv("data/chicago_officer_profile.csv")
chicago_officer_profiles <- chicago_officer_profiles %>%
  select(UID, race)

chicago_complaints_by_offcier_race <- left_join(chicago_complaints, chicago_officer_profiles, by="UID") %>%
  filter(race != "") #there is one officer whose race is unknown

chicago_complaints_by_offcier_race <- chicago_complaints_by_offcier_race %>%
  group_by(UID, cr_id, race) %>%
  summarize() %>%
  ungroup()

chicago_complaints_by_offcier_race <- chicago_complaints_by_offcier_race %>%
  group_by(race) %>%
  summarize(count = n()) %>%
  mutate(percent = count / nrow(chicago_complaints_by_offcier_race) * 100) %>%
  mutate(race = factor(race)) %>%
  arrange(percent)

chicago_complaints_by_offcier_race %>%
  ggplot() +
  geom_bar(aes(x = fct_reorder(race, percent), y = percent), stat = "identity", fill = "brown") +
  labs(title = "Chicago 2007-2017 complaints by officer race") +
  xlab("Officer Race") +
  ylab("Percent") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(panel.background = element_rect(fill = "white", colour = "white",
                                size = 2, linetype = "solid"),
          panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                colour = "gray"),
          panel.grid.major.x = element_blank())
```
```{r NYC-}