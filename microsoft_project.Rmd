---
title: "Data Science Summer School - MSR NYC"
author: "Nikola Baci"
date: "6/21/2021"
output: 
  html_document:
    toc: true
    theme: united
---

```{r setup}
library(tidyverse)
library(lubridate)
```

## Small share of US police draw third of complaints in big cities
#### Article by [FINANCIAL TIMES](https://www.ft.com/content/141182fc-7727-4af8-a555-5418fa46d09e)

## Overview of the article
TODO: A summary of the article (I wish we could use the summary() function)

## Workflow
To ensure a smooth reading and quick understanding of the notebook, please take a
moment to get familiar with the structure of the notebook.

In the first section we read all the files for each of the cities.
Then for each city we do the following:
1. Data exploration and data wrangling - in order to graph the deciles of each city, we need to 
modify the data and construct new tables to aid in achieving our goals.
2. Plot the decies for each city

## Data

Data for NYC can be found [here](https://github.com/new-york-civil-liberties-union/NYPD-Misconduct-Complaint-Database-Updated).

Data for Chicago can be found [here](https://github.com/invinst/chicago-police-data/blob/master/data/unified_data/complaints/complaints-accused.csv.gz), [here](https://github.com/invinst/chicago-police-data/blob/master/data/unified_data/complaints/complaints-complaints.csv.gz) and [here](https://github.com/invinst/chicago-police-data/blob/master/data/unified_data/complaints/officer-filed-complaints__2017-09.csv.gz).

Data for Philadephia can be found [here]() and [here]().

<<<<<<< HEAD
```{r Chicago-Data}
# data link: https://github.com/invinst/chicago-police-data
chicago_data <- read.csv("data/chicago_misconduct_complaint_dataset.csv")
```
=======
```{r Data}
nyc_data <- read.csv("data/nyc_misconduct_complaint_dataset.csv")
>>>>>>> f7bcee47d5913f62f7e19442b6b186f64a549ba3

chicago_complaints_accused <- read.csv("data/complaints-accused.csv")

chicago_complaints_complaints <- read.csv("data/complaints-complaints.csv")

chicago_complaints_by_officers <- read.csv("data/officer-filed-complaints__2017-09.csv")

```

## NYC 

In the next chuck of code we create the necessary table to help us in creating the 
graph for NYC data.

### Data Wrangling
```{r NYC-Data-Wrangling, warning=FALSE}

# Goal: Bucket each officer in one of the 10 buckets by the number of complaints.
# Note: Some complaints include several allegations for the same officer
# or for a number of officers
# Note: The names are not unique or sufficient to be used to identify each officer.

nyc_by_num_complaints <- nyc_data %>%
  mutate(ReceivedDate = mdy(ReceivedDate)) %>% #convert from char to Date type
  filter(ReceivedDate >= "2007-01-01", ReceivedDate <= "2017-12-31") %>%  # get only the period between 2007-2017
  group_by(OfficerID, ComplaintID) %>%
  summarize() %>%                                       # count one officer per complaint 
  summarize(num_of_complaints = n()) %>%                # count the total complaints per officer
  arrange(num_of_complaints)                            # order in ascending order

total_complaints <- sum(nyc_by_num_complaints$num_of_complaints)  # sum of all complaints, used to obtain the percents for each bin

nyc_by_num_complaints <- nyc_by_num_complaints %>%
  mutate(bin_number = 1:nrow(nyc_by_num_complaints)) %>%  # create a new column to place the bin number 1 to 10
  mutate(bin_number = ntile(bin_number, 10)) # use the ntile function to put rows in the right bins

# collapse the table to only 10 rows that represent the bins
# for each bin find the percentage of the complaints that the bin has
# compared to the total
nyc_by_num_complaints <- nyc_by_num_complaints %>%
  group_by(bin_number) %>%
  summarize(total_complaints = (sum(num_of_complaints) / total_complaints) * 100)
```
### Graphing
Graph the deciles for NYC police complaint

```{r NYC-Graph}

nyc_by_num_complaints <-  nyc_by_num_complaints %>%
  mutate(color = c(rep(0, 9), 1)) # to help with the bar colors

# graph the deciles (bins) and their percentages
nyc_by_num_complaints %>%
  ggplot()+
  geom_histogram(aes(x = bin_number, y = total_complaints, fill = color), stat="identity", show.legend = F)+
  scale_x_continuous(breaks = seq(1, 10, 1)) + #set x-axis to go up by 1
  xlab("Decile")+
<<<<<<< HEAD
  ylab("Percent of total complaints")

```


# This part of our project includes Philadelphia data from 2015-2021 including pending comlaints 



```{r Philly - Data}

# Links to the datasets:

# OPen-Philly-Data
# https://www.opendataphilly.org/dataset/police-complaints/resource/e7477284-0045-4f37-8aeb-182616f736e8
# https://www.opendataphilly.org/dataset/police-complaints/resource/7f7d472f-c49c-4364-b6e0-3a079e6b7d7f

# Sam Learner GitHub
# https://raw.githubusercontent.com/sdl60660/philly_police_complaints/master/raw_data/ppd_complaints.csv
# https://raw.githubusercontent.com/sdl60660/philly_police_complaints/master/raw_data/ppd_complaints_7-18.csv
# https://raw.githubusercontent.com/sdl60660/philly_police_complaints/master/raw_data/ppd_complaint_disciplines.csv



### two Open-Data-Philly files clean up
open_philly_complaints <- read.csv('data/ppd_complaints_open_philly.csv',header=T) %>%
  subset(select=-summary) %>%
  mutate(date_received = as.Date(date_received))


open_philly_finding <- read.csv('data/ppd_complaint_disciplines_open_philly.csv',header=T) %>% na.omit()

### Joined Open Philly Data
open_philly_data <- open_philly_finding %>% left_join(open_philly_complaints,by='complaint_id') %>%
  filter(date_received >= '2015-04-01', date_received < '2021-04-01')

```



```{r}
### ### three Sam-Data-Philly files clean up

sam_philly_complaints <- read.csv('data/philly_complaints_dataset_sam_cap_number.csv', header = T) %>%
  mutate(date_received = as.Date(date_received))
  

# rename columns from sam_philly_complaints data set 
sam_philly_complaints <- rename(sam_philly_complaints, complaint_id = cap_number, district_occurrence = dist_occurrence)

# Philly Sam finding data: complaint_id, date_received
sam_philly_findings <- read.csv('data/philly_complaints_dataset_sam.csv',header=T) %>% #na.omit() %>%
  mutate(date_received = mdy(date_received)) %>% # change the date format here 
  select(-shortened_summary)


# Philly Sam complaints disciplines data: complaint_id, officer_id
sam_philly_disciplines <- read.csv('data/philly_complaints_disciplines_sam.csv') %>%
  select(complaint_id, officer_id)

# Left join to  sam_philly_complaints and sam_philly_findings
joined_sam_philly_data <- bind_rows(sam_philly_complaints, sam_philly_findings) %>%
  left_join(sam_philly_disciplines, by="complaint_id") %>%
  filter(date_received >= "2015-01-01", ! is.na(officer_id))
=======
  ylab("Percent of total complaints") +
  theme(panel.background = element_rect(fill = "white", colour = "white",
                                size = 2, linetype = "solid"), # set background to white
          panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',
                                colour = "gray")) # only horizontal marks
  
```

## Chicago 

### Data Wrangling
Now we proceed to working with the Chicago data and obtraining the tables to
draw the bars.

```{r Chicago-Data-Wrangling}

chicago_accused_selected <-  chicago_complaints_accused %>%
  select(UID, cr_id, link_UID) #select only 3 out of the 10 columns

chicago_complaints_selected <- chicago_complaints_complaints %>%
  select(cr_id, complaint_date, closed_date) %>% #select only 3 out of the 11 columns
  mutate(complaint_date = ymd(complaint_date), closed_date = ymd(closed_date)) #turn char dates to Date-types

chicago_officers_selected <- chicago_complaints_by_officers %>%
  mutate(flag = 1, cr_id = as.character(cr_id)) #add a flag column, will help in keeping only the citizens complaints

#create a table that has three essential columns: officer id, complaint id, and data of complaint
chicago_complaints <- inner_join(chicago_accused_selected, chicago_complaints_selected, by="cr_id") %>%
  filter(complaint_date >= "2007-01-01",  closed_date <= "2017-12-31") #choose only period 2007-2017

#join the above table with the complaints filed by officers
chicago_complaints_citizens <- left_join(chicago_complaints, chicago_officers_selected, by="cr_id")%>%
  filter(is.na(flag), !is.na(closed_date)) #remove complaints that are done by officers or that are not closed yet
>>>>>>> f7bcee47d5913f62f7e19442b6b186f64a549ba3

```
### Graphing
Now we can graph the decile bars. 
Note: the data includes the only the citizen complaints that were registered on or after
01/01/2007 and were closed before 01/01/2018.

```{r Explore Chicago-Graph}
#Note: the code is the same as in NYC-Graph above, the only thing that changes is the
#data table in the next line and the variables to indicate that this data is for Chicago.
chicago_by_num_complaints <- chicago_complaints_citizens %>%
  group_by(UID, cr_id) %>%
  summarize() %>%
  summarize(num_of_complaints = n()) %>% 
  arrange(num_of_complaints)

```{r Philly- Graph}
# join the third Sam data set, it is needed because it contains officer_id
joined_sam_and_open_philly_data <- bind_rows(open_philly_data, joined_sam_philly_data)
  

<<<<<<< HEAD
philly <- joined_sam_and_open_philly_data %>%
  group_by(officer_id, complaint_id) %>%
  summarize() %>%                                       # count one officer per complaint 
  summarize(num_of_complaints = n()) %>%                # count the total complaints per officer
  arrange(num_of_complaints)                            # order in ascending order

total_complaints <- sum(philly$num_of_complaints)  # sum of all complaints, used to obtain the percents for each bin

philly <- philly %>%
  mutate(bin_number = 1:nrow(philly))  # create a new column to place the bin number 1 to 10
=======
total_complaints <- sum(chicago_by_num_complaints$num_of_complaints)  

chicago_by_num_complaints <- chicago_by_num_complaints %>%
  mutate(bin_number = 1:nrow(chicago_by_num_complaints)) %>%  
  mutate(bin_number = ntile(bin_number, 10))

chicago_by_num_complaints <- chicago_by_num_complaints %>%
  group_by(bin_number) %>%
  summarize(total_complaints = (sum(num_of_complaints) / total_complaints) * 100)

chicago_by_num_complaints <-  chicago_by_num_complaints %>%
  mutate(color = c(rep(0, 9), 1))

chicago_by_num_complaints %>%
  ggplot()+
  geom_histogram(aes(x = bin_number, y = total_complaints, fill = color), stat="identity", show.legend = F)+
  scale_x_continuous(breaks = seq(1, 10, 1))+
  xlab("Decile")+
  ylab("Percent of total complaints") +
  theme(panel.background = element_rect(fill = "white", colour = "white",
                                size = 2, linetype = "solid"),
          panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                colour = "gray"),
          panel.grid.major.x = element_blank())
```
>>>>>>> f7bcee47d5913f62f7e19442b6b186f64a549ba3

bin <- 1    # keep track of the current bin
bin_size = ceiling(nrow(philly) / 10)  # the size of each bin
count <- 0  # keep track of the bin's count, when it is equal to bin_size then start over

# Go through all the rows in the table and place each officer in the corresponding bin
for(n in 1:nrow(philly)){
  philly[n, "bin_number"] = bin
  count <- count + 1
  if(count == bin_size){
    count <- 0
    bin <- bin + 1
  }
}

# collapse the table to only 10 rows that represent the bins
# for each bin find the percentage of the complaints that the bin has
# compared to the total
philly <- philly %>%
  group_by(bin_number) %>%
  summarize(total_complaints = (sum(num_of_complaints) / total_complaints) * 100)

# graph the deciles (bins) and their percentages
philly %>%
  ggplot()+
  geom_histogram(aes(x = bin_number, y = total_complaints), stat="identity")+
  scale_x_continuous(breaks = seq(1, 10, 1))+
  xlab("Decile")+
  ylab("Percent of total complaints")

```
